# Pico 8x8 矩陣鍵盤韌體

這是一個基於 Raspberry Pi Pico (RP2040) 的 8x8 (64鍵) 自訂機械鍵盤韌體專案。它使用 Arduino-Pico 核心，並透過 74HC595 和 74HC165 晶片來擴展 I/O，僅用 3 個 GPIO 引腳就完成了 64 個按鍵的掃描。此外，還額外擴展了 2 個 LED 指示燈。

韌體最終將 Pico 模擬成一個標準的 USB HID 鍵盤，可以被任何現代作業系統即插即用，同時保留了方便的序列埠除錯功能。

**「這句話就是用這個鍵盤輸入的」** —— 專案成功的最好證明！

## ✨ 主要功能

*   **高效 I/O 擴展**：僅用 3 個 Pico GPIO 引腳驅動 8x8 (64鍵) 矩陣和 2 個 LED。
*   **USB HID 鍵盤**：被電腦識別為標準鍵盤，隨插即用。
*   **複合式 USB 裝置**：同時啟用鍵盤功能和序列埠，方便即時除錯。
*   **雙模式系統**:
    *   **正常打字模式**: 作為一個標準鍵盤工作。
    *   **除錯模式**: 透過序列埠輸出按鍵的物理座標 `(row, col)`，極大地方便了 Keymap 的配置與修改。
*   **韌體層級熱鍵**：使用 `右Shift` + `左Ctrl` 組合鍵在兩種模式間自由切換。
*   **LED 狀態指示**:
    *   LED 1: （目前留空，可自訂，例如用於 CapsLock 指示）。
    *   LED 2: 指示當前是否處於除錯模式（亮起 = 除錯模式）。
*   **全鍵無衝 (NKRO)**：底層支援 6-Key Rollover，可透過修改 HID 報告描述符實現全鍵無衝。
*   **高度客製化**: 使用者可以透過修改 `keymap` 陣列輕鬆定義自己的按鍵佈局。
*   **可靠的掃描邏輯**:
    *   採用「二段式脈衝」確保掃描時序穩定。
    *   針對 74HC165 的特性自訂 `shiftIn` 邏輯，避免丟失數據。
    *   對硬體掃描數據進行「水平鏡像」，使 `keymap` 的定義符合物理直覺。

## ⚙️ 硬體需求

### 主要元件
*   Raspberry Pi Pico (或任何 RP2040 開發板)
*   1 x 74HC595 (8位元移位暫存器，用於行掃描輸出)
*   1 x 74HC165 (8位元並行輸入移位暫存器，用於列讀取)
*   2 x D型正反器 (或第二顆 74HC595，用於擴展 LED 輸出)
*   8x8 矩陣鍵盤 (64個按鍵和二極體)
*   2 x LED 指示燈
*   下拉電阻 (為 74HC165 的每個輸入引腳配置)

### GPIO 連接

| Pico GPIO | 連接目標                                        | 功能描述                                   |
| :-------- | :---------------------------------------------- | :----------------------------------------- |
| **GP15**  | 74HC595 的 `DS` (Serial Data In)                | 數據輸出 (Pico -> 595)                     |
| **GP14**  | 74HC595 `RCLK` **和** 74HC165 `nPL` (共用)      | 鎖存輸出 (上升緣) / 並行加載輸入 (低電位) |
| **GP26**  | 74HC595 `SHCP` **和** 74HC165 `SHCP` (共用)      | 共用的移位時脈                             |
| **GP27**  | 74HC165 的 `Q7` (Serial Data Out)               | 數據輸入 (165 -> Pico)                     |

### 晶片串接
*   **輸出鏈 (595)**: `Pico GP15` -> `595(IC1) DS` -> `595(IC1) Q7'` -> `DFF(IC2) D` -> ...
*   **時脈與鎖存**：所有晶片的時脈腳和鎖存腳都並聯到對應的 Pico GPIO。

## 🛠️ 軟體設定與編譯

### Arduino IDE 環境
1.  安裝 **Arduino IDE**。
2.  在「開發板管理器」中，安裝 **Earle F. Philhower, III** 的 **Raspberry Pi Pico/RP2040** 核心。
3.  在 **工具 > 開發板** 中選擇 "Raspberry Pi Pico"。
4.  **【最重要的一步】** 在 **工具 > USB Stack** 中，選擇 **"Adafruit TinyUSB"**。這會啟用複合式 USB 裝置功能。

### 編譯與上傳
1.  用 Arduino IDE 打開 `.ino` 檔案。
2.  連接 Pico 到電腦。
3.  選擇正確的 COM 連接埠。
4.  點擊「上傳」按鈕。

## ⌨️ 使用說明

1.  **初次連接**: 上傳程式碼後，Pico 將被電腦識別為一個複合式裝置（鍵盤 + 序列埠）。
2.  **預設模式**: 韌體預設進入**除錯模式**。此時 **LED 2** 會亮起。
3.  **除錯模式**:
    *   打開 Arduino IDE 的「序列埠監控器」（鮑率設為 115200）。
    *   按下鍵盤上的任意按鍵。
    *   序列埠監控器會顯示一個 8x8 的狀態矩陣，並打印出被按下按鍵的物理座標，例如 `Key Pressed at: (Row: 2, Col: 6)`。
    *   使用這個功能來確認每個按鍵的座標，以便精確修改下方的 `keymap`。
4.  **切換到正常打字模式**:
    *   同時按下 **右 Shift** 和 **左 Ctrl** 鍵。
    *   **LED 2** 將會熄滅。
    *   現在，您的鍵盤可以像一個普通鍵盤一樣，在任何文字編輯器中輸入文字。
5.  **切換回除錯模式**:
    *   再次同時按下 **右 Shift** 和 **左 Ctrl** 鍵即可。

## 📝 Keymap 客製化

要定義您自己的按鍵佈局，您只需要修改原始碼中的 `keymap_hid` 陣列。

```cpp
const uint8_t keymap_hid[8][8] = {
  // COL 0        1         2         3         4         ...
  {HID_KEY_1, HID_KEY_3, HID_KEY_5, ... }, // ROW 0
  {HID_KEY_Q, HID_KEY_E, HID_KEY_T, ... }, // ROW 1
  // ... and so on
};
```
*   陣列的 `[row][col]` 索引與您在**除錯模式**下看到的座標完全對應。
*   陣列中的值是標準的 **USB HID Usage ID**（也稱為 Scancode）。您可以在程式碼頂部的 `#define` 區域找到常用鍵的定義，或查詢相關的 USB HID 文件。

## 💡 未來可擴展方向

*   實現多層 Keymap (Fn 層)。
*   加入巨集功能。
*   Tap Dance（輕觸/長按不同功能）。
*   RGB LED 燈光效果。
*   OLED 螢幕狀態顯示。

---
